<!DOCTYPE html>
<html lang="en" data-root="../">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Leak Detection — Tantrums Docs</title>
<link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="layout">
<main class="main">
<div class="topbar">
  <div class="breadcrumb">
    <button class="menu-btn" onclick="document.querySelector('.sidebar').classList.toggle('open');document.querySelector('.overlay').classList.toggle('on')">☰</button>
    <span class="bc-par">Tantrums</span><span class="bc-sep">/</span>
    <span class="bc-cur">Leak Detection</span>
  </div>
  <div class="topbar-r"><span class="ver-tag">v0.2.0</span></div>
</div>
<div class="page">
<div class="ph">
  <span class="ph-tag">Memory</span>
  <h1>Leak Detection</h1>
  <p class="ph-desc">Exit-time leak reporting with line numbers, types, sizes, and memleaklog.txt.</p>
</div>

<h2 id="how">How It Works</h2>
<p>Layer 7 of the memory safety system. On program exit, the VM checks its pointer registry for any allocations that were never freed. It reports them with line numbers, function names, types, and sizes.</p>

<h2 id="small">Small Leak Report (≤5 leaks)</h2>
<p>Printed directly to console:</p>
<pre><div class="ch"><span class="ch-lang">terminal</span><button class="copy-btn">Copy</button></div><code><span class="er">[Tantrums Warning] Memory leak detected: 3 allocation(s) not freed</span>
  alloc at line 4 in main — int (96 bytes)
  alloc at line 7 in foo  — int (96 bytes)
  alloc at line 9 in main — int (96 bytes)
Total Leaked Memory: 288 bytes = 0.28 KB</code></pre>

<h2 id="large">Large Leak Report (&gt;5 leaks)</h2>
<p>Redirected to <code>memleaklog.txt</code> in the same directory as the <code>.42ass</code> file:</p>
<pre><div class="ch"><span class="ch-lang">terminal</span><button class="copy-btn">Copy</button></div><code><span class="er">[Tantrums Warning] Memory leak detected: 47 allocation(s) not freed.</span>
See memleaklog.txt in the same directory as the executing bytecode.</code></pre>

<pre><div class="ch"><span class="ch-lang">text</span><button class="copy-btn">Copy</button></div><code>TANTRUMS MEMORY LEAK REPORT
============================
Executable: main.42ass
Leaks: 47 allocations
============================
  alloc at line 8 in main — int (96 bytes) [x47]
============================
SUMMARY
  Total leaked: 4,512 bytes
              = 4.41 KB
              = 0.00 MB
              = 0.00 GB
============================</code></pre>

<h2 id="size">Why 96 Bytes Per int?</h2>
<p>Tantrums uses a uniform <code>Value</code> struct for all heap allocations. Each struct is 96 bytes regardless of the logical type, because it contains:</p>
<ul class="escape-list">
  <li><span class="enum">→</span>A type enum (which type this value is)</li>
  <li><span class="enum">→</span>A union of all possible value representations (int, float, string buffer, list pointer, map pointer)</li>
  <li><span class="enum">→</span>Alignment padding to 96 bytes</li>
  <li><span class="enum">→</span>malloc overhead from the system allocator</li>
</ul>

<h2 id="arena">Leak Detection With #allowMemoryLeaks</h2>
<pre><div class="ch"><span class="ch-lang">tantrums (.42AHH)</span><button class="copy-btn">Copy</button></div><code><span class="dr">#autoFree false;</span>
<span class="dr">#allowMemoryLeaks true;</span>

<span class="kw">tantrum</span> <span class="ty">void</span> <span class="fn">main</span>()
{{
    <span class="ty">int*</span> a = <span class="kw">alloc</span> <span class="ty">int</span>(1);
    <span class="ty">int*</span> b = <span class="kw">alloc</span> <span class="ty">int</span>(2);
    <span class="fn">print</span>(*a + *b);
    <span class="cm">// intentionally not freed — arena pattern</span>
    <span class="cm">// exit report still prints/writes to memleaklog.txt</span>
    <span class="cm">// but compilation succeeded and program ran</span>
}}</code></pre>

<div class="callout info"><span class="ci">ⓘ</span><div class="cb"><strong>OS Reclaims</strong><p>When a process exits, the OS reclaims all its memory regardless of whether the program freed it. The arena pattern is legitimate for programs that allocate once and exit — the leak detector reports it but <code>#allowMemoryLeaks true</code> means it won't stop compilation.</p></div></div>

<div class="pnav"><a href="escape-analysis.html" class="pnav-btn"><span class="pnl">← Previous</span><span class="pnt">Escape Analysis</span></a><a href="builtins.html" class="pnav-btn r"><span class="pnl">Next →</span><span class="pnt">Built-in Functions</span></a></div>
</div>
</main>
</div>
<script src="../js/sidebar.js"></script>
<script src="../js/main.js"></script>
</body>
</html>